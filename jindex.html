<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Soil Bag Labels — 30 per sheet (Offline)</title>

<!-- PWA bits -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b5fff">

<style>
  /* App UI */
  :root { --blue:#0b5fff; --text:#111; --muted:#5b6570; --border:#e6e8eb; --bg:#f6f7f9; }
  html,body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,system-ui,Arial,Helvetica,sans-serif}
  .wrap{max-width:720px;margin:0 auto;padding:16px}
  h1{font-size:18px;margin:8px 0 12px}
  .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:14px}
  label{display:block;font-size:12px;margin:8px 0 4px;color:#333}
  input[type="text"],input[type="number"]{width:100%;border:1px solid #cfd6dd;border-radius:10px;padding:10px 12px;font-size:16px;background:#fff}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  button{margin-top:12px;appearance:none;border:1px solid var(--blue);background:var(--blue);color:#fff;font-weight:600;border-radius:10px;padding:12px 14px;font-size:16px;width:100%}
  .hint{font-size:12px;color:var(--muted);margin-top:8px}
  .status{margin-top:10px;font-size:14px;min-height:1.2em}
  .note{margin-top:8px;font-size:13px;color:#d33;font-weight:500}
</style>
</head>
<body>
<div class="wrap">
  <h1>Soil Bag Labels — 30 per sheet (Offline)</h1>
  <div class="card">
    <label>Customer Location *</label>
    <input id="customer" type="text" required>

    <label>Grower / Farm / Field *</label>
    <input id="field" type="text" required>

    <div class="row">
      <div>
        <label>Number of Samples *</label>
        <input id="count" type="number" min="1" required>
      </div>
      <div>
        <label>Starting Number (default 1)</label>
        <input id="start" type="number" min="1" value="1">
      </div>
    </div>

    <button id="goBtn">Generate</button>
    <div class="hint">Print at <b>100% / Actual Size</b> on 30-up sheets (3×10). If alignment needs a nudge, we can tweak margins.</div>
    <div class="status" id="status">Offline-ready once installed. Use Share → Add to Home Screen.</div>
    <div class="note" id="note"></div>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const statusEl = $('status'), noteEl = $('note');

  // --- Register service worker for offline ---
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', async () => {
      try {
        const reg = await navigator.serviceWorker.register('./sw.js', {scope: './'});
        statusEl.textContent = 'Ready ✓ (works offline after Add to Home Screen)';
      } catch (e) {
        statusEl.textContent = 'Ready (no SW) — still works, but won’t cache offline.';
      }
    });
  } else {
    statusEl.textContent = 'Ready (no SW support on this device).';
  }

  // Label geometry (inches). Tell me if you want tiny shifts; we’ll tweak LM/TM.
  const LM = 0.1875;  // left margin
  const TM = 0.50;    // top margin
  const LABEL_W = 2.625;
  const LABEL_H = 1.0;
  const PITCH_X = 2.75; // horizontal distance between left edges
  const PITCH_Y = 1.0;  // vertical distance between top edges

  $('goBtn').addEventListener('click', () => {
    const customer = ($('customer').value || '').trim();
    const field    = ($('field').value || '').trim();
    const count    = parseInt(($('count').value || '0'), 10);
    let   start    = parseInt(($('start').value || '1'), 10);
    if (!customer || !field || !count || count < 1) {
      statusEl.textContent = 'Please fill Customer, Field, and Count.';
      return;
    }
    if (!start || start < 1) start = 1;

    statusEl.textContent = 'Building labels…';
    const html = buildPrintHtml(customer, field, count, start);
    openPrintWindow(html);
    statusEl.textContent = 'Ready ✓';
    noteEl.textContent = 'If nothing opens, allow pop-ups or try again.';
  });

  function esc(s){
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;')
                    .replace(/>/g,'&gt;').replace(/"/g,'&quot;')
                    .replace(/'/g,'&#39;');
  }

  function buildPrintHtml(customer, field, count, startNum){
    let h = '';
    h += '<!DOCTYPE html><html><head><meta charset="utf-8">';
    h += '<title>Labels - ' + esc(field) + '</title>';
    h += '<style>';
    h += '@page { size: Letter; margin: 0; }';
    h += 'html,body{margin:0;padding:0;background:#fff;}';
    h += '.page{width:8.5in;height:11in;position:relative;page-break-after:always;}';
    h += '.label{position:absolute;width:'+LABEL_W+'in;height:'+LABEL_H+'in;'
       + 'text-align:center;overflow:hidden;box-sizing:border-box;padding:0.04in;'
       + 'font-family:Arial,Helvetica,sans-serif;}';
    h += '.small{font-size:10pt;line-height:1.05;}';
    h += '.tag{font-size:10pt;line-height:1.0;margin-top:0.02in;}';
    h += '.big{font-size:26pt;font-weight:800;line-height:1.0;}';
    h += '@media screen{body{background:#eee} .page{box-shadow:0 0 6px rgba(0,0,0,.15);margin:8px auto}}';
    h += '</style></head><body>';

    const pages = Math.ceil(count / 30);
    let idx = startNum;

    for (let p = 0; p < pages; p++) {
      h += '<div class="page">';
      for (let r = 0; r < 10; r++) {
        for (let c = 0; c < 3; c++) {
          if ((idx - startNum) >= count) break;
          const left = LM + c * PITCH_X;
          const top  = TM + r * PITCH_Y;
          h += '<div class="label" style="left:'+left+'in;top:'+top+'in;">'
             +   '<div class="small">'+ esc(customer) +'</div>'
             +   '<div class="small">'+ esc(field)    +'</div>'
             +   '<div class="tag">Sample ID</div>'
             +   '<div class="big">'+ idx +'</div>'
             + '</div>';
          idx++;
        }
      }
      h += '</div>';
    }

    // Auto-open iOS print sheet after render
    h += '<script>setTimeout(function(){try{window.focus();window.print();}catch(e){}},400);<\/script>';
    h += '</body></html>';
    return h;
  }

  function openPrintWindow(html){
    const w = window.open('', '_blank');
    if (!w) {
      // Popup blocked — fall back to same tab
      const doc = document.open('text/html', 'replace');
      doc.write(html); doc.close();
      return;
    }
    w.document.open();
    w.document.write(html);
    w.document.close();
  }
})();
</script>
</body>
</html>
